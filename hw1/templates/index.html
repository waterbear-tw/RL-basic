<!DOCTYPE html>
<html>
  <head>
    <title>Grid World</title>
    <style>
      .grid-container {
        display: flex;
        justify-content: space-around;
        margin: 20px;
      }
      table {
        border-collapse: collapse;
      }
      td {
        width: 40px;
        height: 40px;
        border: 1px solid black;
        text-align: center;
        cursor: pointer;
      }
      .start {
        background-color: green;
      }
      .end {
        background-color: red;
      }
      .obstacle {
        background-color: gray;
      }
    </style>
  </head>
  <body>
    <div>
      <label>Grid Size (5-9):</label>
      <input type="number" id="size" min="5" max="9" value="5" />
      <button onclick="initGrid()">Initialize</button>
      <button onclick="reset()">Reset</button>
      <button onclick="calculate()">Calculate</button>
    </div>

    <div class="grid-container">
      <div>
        <h3>Main Grid</h3>
        <table id="main-grid"></table>
      </div>
      <div>
        <h3>Policy Grid</h3>
        <table id="policy-grid"></table>
      </div>
      <div>
        <h3>Value Grid</h3>
        <table id="value-grid"></table>
      </div>
    </div>

    <script>
      function initGrid() {
        const size = document.getElementById("size").value;
        fetch("/init_grid", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `size=${size}`,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Init response:", data);
            if (data.success) updateGrids();
          })
          .catch((error) => console.error("Init error:", error));
      }

      function reset() {
        fetch("/reset", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            console.log("Reset response:", data);
            if (data.success) {
              clickMode = "start";
              updateGrids();
            }
          })
          .catch((error) => console.error("Reset error:", error));
      }

      function updateCell(x, y, type) {
        fetch("/update_cell", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `x=${x}&y=${y}&type=${type}`,
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Update cell response:", data);
            if (data.success) updateGrids();
          })
          .catch((error) => console.error("Update cell error:", error));
      }

      function calculate() {
        console.log("Calculate button clicked");
        fetch("/calculate", { method: "POST" })
          .then((response) => response.json())
          .then((data) => {
            console.log("Calculate response:", data);
            if (data.success) {
              updateGrids();
            } else {
              alert(data.message || "Calculation failed");
            }
          })
          .catch((error) => console.error("Calculate error:", error));
      }

      function updateGrids() {
        console.log("Updating grids...");
        fetch("/get_state")
          .then((response) => response.json())
          .then((state) => {
            console.log("Fetched state:", state);
            const size = state.size;
            let mainHtml = "",
              policyHtml = "",
              valueHtml = "";

            for (let i = 0; i < size; i++) {
              mainHtml += "<tr>";
              policyHtml += "<tr>";
              valueHtml += "<tr>";
              for (let j = 0; j < size; j++) {
                let mainClass = "";
                if (state.start && state.start[0] === i && state.start[1] === j)
                  mainClass = "start";
                else if (state.end && state.end[0] === i && state.end[1] === j)
                  mainClass = "end";
                else if (
                  state.obstacles.some((obs) => obs[0] === i && obs[1] === j)
                )
                  mainClass = "obstacle";

                mainHtml += `<td class="${mainClass}" onclick="cellClick(${i},${j})"></td>`;

                const policyValue =
                  state.policy && state.policy[i] && state.policy[i][j]
                    ? state.policy[i][j]
                    : "";
                const valueValue =
                  state.values && state.values[i] && state.values[i][j] !== null
                    ? Number(state.values[i][j]).toFixed(2)
                    : "";

                policyHtml += `<td>${policyValue}</td>`;
                valueHtml += `<td>${valueValue}</td>`;
              }
              mainHtml += "</tr>";
              policyHtml += "</tr>";
              valueHtml += "</tr>";
            }

            console.log("Main HTML:", mainHtml);
            console.log("Policy HTML:", policyHtml);
            console.log("Value HTML:", valueHtml);

            document.getElementById("main-grid").innerHTML = mainHtml;
            document.getElementById("policy-grid").innerHTML = policyHtml;
            document.getElementById("value-grid").innerHTML = valueHtml;
            console.log("Grids updated successfully");
          })
          .catch((error) => console.error("Update grids error:", error));
      }

      let clickMode = "start";
      function cellClick(x, y) {
        if (clickMode === "start") {
          updateCell(x, y, "start");
          clickMode = "end";
        } else if (clickMode === "end") {
          updateCell(x, y, "end");
          clickMode = "obstacle";
        } else if (clickMode === "obstacle") {
          updateCell(x, y, "obstacle");
        }
      }

      document.addEventListener("keydown", (e) => {
        if (e.key === "1") clickMode = "start";
        if (e.key === "2") clickMode = "end";
        if (e.key === "3") clickMode = "obstacle";
        console.log("Current mode:", clickMode);
      });

      updateGrids();
    </script>
  </body>
</html>
